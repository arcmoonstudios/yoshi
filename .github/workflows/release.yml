# Official Release Workflow - Follows PUBLISHING.md Guidelines
name: Official Release

on:
  push:
    tags: ["v*"]
  workflow_dispatch:

jobs:
  validate-and-publish:
    name: ğŸš€ Validate & Publish to crates.io
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ¦€ Install Rust (stable)
        uses: dtolnay/rust-toolchain@stable

      - name: ğŸ“¦ Cache dependencies
        uses: swatinem/rust-cache@v2
        with:
          shared-key: "release-publish"
          cache-on-failure: true

      - name: ğŸ” Prerequisites Check
        run: |
          echo "ğŸ§ª Running all tests..."
          cargo test --workspace
          echo "ğŸ”¨ Building in release mode..."
          cargo build --release
          echo "ğŸ“ Running clippy checks..."
          cargo clippy --all-targets --all-features -- -D warnings
          echo "ğŸ“š Building documentation..."
          cargo doc --all-features --no-deps
        env:
          CARGO_TERM_COLOR: always

      - name: ğŸ“¦ Publish yoshi-std
        run: |
          echo "ğŸ“¦ Publishing yoshi-std..."
          cd yoshi-std
          cargo publish --token ${{ secrets.CARGO_REGISTRY_TOKEN }}
        env:
          CARGO_TERM_COLOR: always

      - name: â³ Wait for yoshi-std availability
        run: |
          echo "â³ Waiting for yoshi-std to be available on crates.io..."
          sleep 30

      - name: ğŸ“¦ Publish yoshi-derive
        run: |
          echo "ğŸ“¦ Publishing yoshi-derive..."
          cd yoshi-derive
          cargo publish --token ${{ secrets.CARGO_REGISTRY_TOKEN }}
        env:
          CARGO_TERM_COLOR: always

      - name: â³ Wait for yoshi-derive availability
        run: |
          echo "â³ Waiting for yoshi-derive to be available on crates.io..."
          sleep 30

      - name: ğŸ“¦ Publish yoshi
        run: |
          echo "ğŸ“¦ Publishing yoshi..."
          cd yoshi
          cargo publish --token ${{ secrets.CARGO_REGISTRY_TOKEN }}
        env:
          CARGO_TERM_COLOR: always

      - name: âœ… Publication Complete
        run: |
          echo "âœ… All Yoshi crates published successfully!"
          echo "ğŸ“¦ yoshi-std ${{ github.ref_name }}"
          echo "ğŸ“¦ yoshi-derive ${{ github.ref_name }}"
          echo "ğŸ“¦ yoshi ${{ github.ref_name }}"
          echo "ğŸš€ Release ${{ github.ref_name }} is live on crates.io!"
